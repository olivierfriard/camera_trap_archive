<!doctype html>
<html lang="it">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Nuova fototrappola</title>

        <!-- Bulma CSS -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css"
        />

        <!-- Leaflet CSS -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            crossorigin=""
        />

        <style>
            #map {
                height: 400px;
                width: 100%;
                border-radius: 8px;
            }
            video {
                max-width: 100%;
                margin-top: 1rem;
                border-radius: 8px;
            }
        </style>
    </head>
    <body>
        <section class="section">
            <div class="container">
                <h1 class="title is-3">Nuova fototrappola</h1>

                {% with messages = get_flashed_messages(with_categories=true) %}
                      {% if messages %}
                        <div id="flashes">
                          {% for category, msg in messages %}
                            {# Map Flask categories to Bulma notification classes #}
                            {% set bulma_class = {
                              'success': 'is-success',
                              'warning': 'is-warning',
                              'info':    'is-info',
                              'danger':  'is-danger',
                              'error':   'is-danger'
                            }[category] if category in ['success','warning','info','danger','error'] else 'is-light' %}

                            <div class="notification {{ bulma_class }}">
                              <button class="delete" aria-label="dismiss"></button>
                              {{ msg }}
                            </div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    {% endwith %}

<form method="post" action="{{ url_for('save_fototrappola') }}">

    <div class="columns is-multiline">
        <div class="column is-one-third">
            <div class="field">
                <label class="label">Codice</label>
                <div class="control">
                    <input class="input" name="codice" required />
                </div>
            </div>
        </div>

        <div class="column is-one-third">
            <div class="field">
                <label class="label">Tipo</label>
                <div class="control">
                    <input class="input" name="tipo" required />
                </div>
            </div>
        </div>

        <div class="column is-one-third">
            <div class="field">
                <label class="label">Intersezioni</label>
                <div class="control">
                    <input class="input" name="intersezioni" />
                </div>
            </div>
        </div>
    </div>

    <div class="columns is-multiline">
        <div class="column is-one-quarter">
            <div class="field">
                <label class="label">Data Inizio</label>
                <div class="control">
                    <input class="input" type="date" name="data_inizio" required />
                </div>
            </div>
        </div>

        <div class="column is-one-quarter">
            <div class="field">
                <label class="label">Data Fine</label>
                <div class="control">
                    <input class="input" type="date" name="data_fine" />
                </div>
            </div>
        </div>

        <div class="column is-one-quarter">
            <div class="field">
                <label class="label">Nome</label>
                <div class="control">
                    <input class="input" name="nome" />
                </div>
            </div>
        </div>

        <div class="column is-one-quarter">
            <div class="field">
                <label class="label">Cognome</label>
                <div class="control">
                    <input class="input" name="cognome" />
                </div>
            </div>
        </div>
    </div>

    <div class="columns is-multiline">
        <div class="column is-one-third">
            <div class="field">
                <label class="label">Regione</label>
                <div class="control">
                    <input class="input" name="regione" required />
                </div>
            </div>
        </div>

        <div class="column is-one-third">
            <div class="field">
                <label class="label">Provincia</label>
                <div class="control">
                    <input class="input" name="provincia" required />
                </div>
            </div>
        </div>

        <div class="column is-one-third">
            <div class="field">
                <label class="label">Comune</label>
                <div class="control">
                    <input class="input" name="comune" required />
                </div>
            </div>
        </div>
    </div>

    <div class="columns is-multiline">
        <div class="column is-one-third">
            <div class="field">
                <label class="label">Latitudine</label>
                <div class="control">
                    <input class="input" id="latInput" name="latitudine"  required />
                </div>
            </div>
        </div>

        <div class="column is-one-third">
            <div class="field">
                <label class="label">Longitudine</label>
                <div class="control">
                    <input class="input" id="lngInput" name="longitudine"  required />
                </div>
            </div>
        </div>

        <div class="column is-one-third">
            <div class="field">
                <label class="label">Altitudine</label>
                <div class="control">
                    <input class="input" type="number" step="1" name="altitudine" />
                </div>
            </div>
        </div>
    </div>

    <p class="help">Clicca sulla mappa per impostare le coordinate.</p>
    <div id="map" style="height: 400px; border-radius: 8px;"></div>

    <br />

    <div class="field">
        <label class="label">Paese (default: Italia)</label>
        <div class="control">
            <input class="input" name="country" value="Italia" />
        </div>
    </div>

    <div class="field is-grouped">
        <div class="control">
            <button class="button is-primary" type="submit">Salva</button>
        </div>
    </div>

</form>
            </div>
        </section>
    </body>

<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
></script>
<script>
const map = L.map("map").setView([45.0, 7.6], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "Â© OpenStreetMap",
}).addTo(map);

let marker = null;

function setCoords(lat, lng) {
    document.getElementById("latInput").value = lat.toFixed(6);
    document.getElementById("lngInput").value = lng.toFixed(6);
}

map.on("click", (e) => {
    const { lat, lng } = e.latlng;

    if (!marker) {
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        marker.on("dragend", (ev) => {
            const pos = ev.target.getLatLng();
            setCoords(pos.lat, pos.lng);
        });
    } else {
        marker.setLatLng([lat, lng]);
    }

    setCoords(lat, lng);
});
</script>
</html>
