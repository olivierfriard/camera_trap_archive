<!doctype html>
<html lang="it">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Avistamento fototrappola</title>

        <!-- Bulma CSS -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css"
        />

        <!-- Leaflet CSS -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            crossorigin=""
        />

        <style>
            #map {
                height: 400px;
                width: 100%;
                border-radius: 8px;
            }
            video {
                max-width: 100%;
                margin-top: 1rem;
                border-radius: 8px;
            }
        </style>
    </head>
    <body>
        <section class="section">
            <div class="container">
                <h1 class="title is-3">Avistamento fototrappola</h1>

                {% with messages = get_flashed_messages() %} {% if messages %}
                <div class="notification is-success">
                    {% for msg in messages %}
                    <p>{{ msg|safe }}</p>
                    {% endfor %}
                </div>
                {% endif %} {% endwith %} {% if video_url %}
                <div class="box mt-5">
                    <h2 class="subtitle is-4">Anteprima video caricato</h2>
                    <video
                        id="video_camtrap"
                        src="{{ video_url }}"
                        width="640"
                        preload="metadata"
                    ></video>
                    <p class="mt-3">
                        <strong>Data:</strong> {{ date }}<br />
                        <strong>Ora:</strong> {{ time_ }}<br />
                    </p>
                </div>
                {% endif %}

                <form
                    id="uploadForm"
                    method="post"
                    action="{{ url_for('save_info') }}"
                    enctype="multipart/form-data"
                >
                    <input
                        type="hidden"
                        name="original_file_name"
                        value="{{ original_file_name }}"
                    />
                    <input
                        type="hidden"
                        name="new_file_name"
                        value="{{ new_file_name }}"
                    />
                    <input
                        type="hidden"
                        name="file_content_md5"
                        value="{{ file_content_md5 }}"
                    />
                    <input type="hidden" name="date" value="{{ date }}" />
                    <input type="hidden" name="time_" value="{{ time_ }}" />
                    <div class="field">
                        <label class="label">Operatore</label>
                        <div class="control">
                            <input
                                class="input"
                                name="operator"
                                type="text"
                                placeholder="operatore"
                                value="{{ operator }}"
                                readonly
                            />
                        </div>
                    </div>
                    <div class="columns is-multiline">
                        <div class="column is-half">
                            <div class="field">
                                <label class="label">ID fototrappola</label>
                                <div class="control">
                                    <input
                                        class="input"
                                        name="camtrap_id"
                                        type="text"
                                        required
                                        value="{{ camtrap_id }}"
                                    />
                                </div>
                            </div>
                        </div>
                        <div class="column is-half">
                            <div class="field">
                                <label class="label">Codice avistamento</label>
                                <div class="control">
                                    <input
                                        class="input"
                                        name="code"
                                        type="text"
                                        value="{{ code }}"
                                        required
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="columns is-multiline">
                        <div class="column is-half">
                            <div class="field">
                                <label class="label">Numero di lupi</label>
                                <div class="control">
                                    <input
                                        class="input"
                                        name="wolf_number"
                                        type="number"
                                        min="0"
                                        max="120"
                                        step="1"
                                        required
                                        value="{{ wolf_number }}"
                                    />
                                </div>
                            </div>
                        </div>
                        <div class="column is-half">
                            <div class="field">
                                <label class="label" for="scalp">SCALP</label>scalp: {{ scalp }}
                                <div class="control">
                                    <div class="select">
                                        <select
                                            id="scalp"
                                            name="scalp"
                                            required
                                        >
                                            <option value="">
                                                Seleziona un codice
                                            </option>
                                            <option
                                                value="C1"
                                                {%
                                                if
                                                scalp=="C1"
                                                %}selected{%endif%}
                                            >
                                                C1
                                            </option>
                                            <option
                                                value="C3"
                                                {%
                                                if
                                                scalp=="C3"
                                                %}selected{%
                                                endif
                                                %}
                                            >
                                                C3
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Note</label>
                        <div class="control">
                            <textarea
                                name="note"
                                class="textarea"
                                placeholder="Digitate le vostre note..."
                            >
{{ notes }}</textarea
                            >
                        </div>
                    </div>

                    <div class="columns is-multiline">
                        <div class="column is-one-third">
                            <div class="field">
                                <label class="label">Latitudine</label>
                                <div class="control">
                                    <input
                                        class="input"
                                        id="latDisplay"
                                        readonly
                                        name="latitude"
                                        value="{{ latitude }}"
                                    />
                                </div>
                            </div>
                        </div>
                        <div class="column is-one-third">
                            <div class="field">
                                <label class="label">Longitudine</label>
                                <div class="control">
                                    <input
                                        class="input"
                                        id="lngDisplay"
                                        readonly
                                        name="longitude"
                                        value="{{ longitude }}"
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="column is-one-third">
                            <div class="field">
                                <label class="label">Codice transetto</label>
                                <div class="control">
                                    <input
                                        class="input"
                                        name="transect_id"
                                        value="{{ transect_id }}"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="help">
                        Clicca sulla mappa per impostare le coordinate della
                        fototrappola.
                    </p>

                    <div id="map" class="mb-4"></div>

                    <div class="field is-grouped">
                        <div class="control">
                            <button class="button is-primary" type="submit">
                                Salva dati
                            </button>
                        </div>
                    </div>
                </form>

                <br /><br />
                <a
                    class="button is-warning is-small"
                    href="{{ url_for('logout') }}"
                    >Logout</a
                >
            </div>
        </section>

        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            crossorigin=""
        ></script>
        <script>
            const map = L.map("map").setView([45.065, 7.68], 13);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: "Â© OpenStreetMap",
            }).addTo(map);

            let marker = null;

            function setPosition(lat, lng) {
                document.getElementById("latDisplay").value = lat.toFixed(6);
                document.getElementById("lngDisplay").value = lng.toFixed(6);
            }

            map.on("click", (e) => {
                const { lat, lng } = e.latlng;
                if (!marker) {
                    marker = L.marker([lat, lng], { draggable: true }).addTo(
                        map,
                    );
                    marker.on("dragend", (ev) => {
                        const p = ev.target.getLatLng();
                        setPosition(p.lat, p.lng);
                    });
                } else {
                    marker.setLatLng([lat, lng]);
                }
                setPosition(lat, lng);
            });
        </script>

        <script>
            const video = document.getElementById("video_camtrap");

            // Hide controls initially
            video.controls = false;

            // Show controls when user clicks or hovers
            video.addEventListener("mouseenter", () => {
                video.controls = true;
            });

            video.addEventListener("mouseleave", () => {
                video.controls = false; // hide controls when mouse leaves and video is playing
            });

            // Optional: show controls when video is paused
            video.addEventListener("pause", () => {
                video.controls = true;
            });
        </script>
    </body>
</html>
